package simpaths.model.taxes;

import jakarta.persistence.*;
import simpaths.model.enums.Gender;

import java.util.LinkedHashSet;
import java.util.Set;
import java.util.HashSet;


/**
 *
 * CLASS TO STORE PERSON-LEVEL DATA FOR IMPUTING TAXES AND BENEFITS
 *
 */
@Entity
public class DonorPerson {

    @Id @Column(name = "ID", unique = true, nullable = false) private Long id;
    @ManyToOne(fetch = FetchType.EAGER, cascade=CascadeType.REFRESH)
    @JoinColumn(name = "TUID", referencedColumnName = "id")
    private DonorTaxUnit taxUnit;
    @OneToMany(fetch = FetchType.EAGER, cascade = CascadeType.ALL, mappedBy = "person")
    private Set<DonorPersonPolicy> policies = new LinkedHashSet<>();

    @Column(name = "DAG") private Integer age;
    //@Column(name = "DGN") private Gender dgn;
    @Column(name = "DGN") private String dgnRaw;
    @Column(name = "WEIGHT") private Double weight;
    @Column(name = "HOURS_WORKED_WEEKLY") private Integer hoursWorkedWeekly;
    @Column(name = "DLLTSD") private Integer dlltsd;
    @Column(name = "CARER") private Integer carer;


    /**
     * CONSTRUCTORS
     */
    public DonorPerson(){}


    /**
     * GETTERS AND SETTERS
     */
    public long getId() {
        return this.id;
    }
    public Integer getAge() { return this.age; }


    public Gender getDgn() {
        if (dgnRaw == null) return null;
        String v = dgnRaw.trim().toUpperCase();
        return switch (v) {
            case "FEMALE" -> Gender.Female;
            case "MALE" -> Gender.Male;
            default -> throw new IllegalStateException("Unknown gender value in DB: " + dgnRaw);
        };
    }


    /** If you ever need the raw DB text */
    public String getDgnRaw() { return dgnRaw; }
    public int getHoursWorkedWeekly() { return this.hoursWorkedWeekly; }
    public int getDlltsd() { return this.dlltsd; }
    public int getCarer() { return 0; }
    public double getWeight() { return this.weight; }
    public Set<DonorPersonPolicy> getPolicies() { return policies; }
    public DonorPersonPolicy getPolicy(int startYear) {
        for ( DonorPersonPolicy policy : policies) {
            if (policy.getFromYear() == startYear)
                return policy;
        }
        return null;
    }
}
